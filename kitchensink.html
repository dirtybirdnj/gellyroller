<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gellyroller API - Kitchen Sink</title>
</head>
<body>
    <h1>Gellyroller API Test Interface</h1>
    <p>Test all API endpoints using the forms below. Results will appear in the response areas.</p>
    
    <h2>Data Output</h2>
    <textarea id="dataOutput" disabled rows="8" cols="100">Waiting for data...</textarea>
    
    <h2>Full Response</h2>
    <textarea id="response" disabled rows="15" cols="100">Waiting for response...</textarea>
    
    <hr>

    <h2>Status & Information</h2>
    
    <h3>Health Check</h3>
    <form data-action="/health" data-method="GET">
        <button type="submit">Get Health Status</button>
    </form>

    <h3>Get Position</h3>
    <form data-action="/position" data-method="GET">
        <button type="submit">Get Current Position</button>
    </form>

    <h3>Get State</h3>
    <form data-action="/state" data-method="GET">
        <button type="submit">Get Full State</button>
    </form>

    <h3>Get Status</h3>
    <form data-action="/status" data-method="GET">
        <button type="submit">Get Status Summary</button>
    </form>

    <h3>Get Configuration</h3>
    <form data-action="/config" data-method="GET">
        <button type="submit">Get Machine Config</button>
    </form>

    <hr>

    <h2>Movement & Control</h2>

    <h3>Home All Axes</h3>
    <form data-action="/home" data-method="POST">
        <label>Axes (optional, e.g., "X Y"): <input type="text" name="axes"></label><br>
        <button type="submit">Home</button>
    </form>

    <h3>Go To Location (Fast)</h3>
    <form data-action="/goto/fast" data-method="POST">
        <label>X: <input type="number" name="x" step="0.01"></label><br>
        <label>Y: <input type="number" name="y" step="0.01"></label><br>
        <label>Z: <input type="number" name="z" step="0.01"></label><br>
        <button type="submit">Move Fast (G0)</button>
    </form>

    <h3>Go To Location (Slow)</h3>
    <form data-action="/goto/slow" data-method="POST">
        <label>X: <input type="number" name="x" step="0.01"></label><br>
        <label>Y: <input type="number" name="y" step="0.01"></label><br>
        <label>Z: <input type="number" name="z" step="0.01"></label><br>
        <label>Feed Rate (F): <input type="number" name="f"></label><br>
        <button type="submit">Move Slow (G1)</button>
    </form>

    <h3>Pause Operation</h3>
    <form data-action="/pause" data-method="POST">
        <button type="submit">Pause</button>
    </form>

    <h3>Cancel Operation</h3>
    <form data-action="/cancel" data-method="POST">
        <button type="submit">Cancel/Stop</button>
    </form>

    <h3>Emergency Stop</h3>
    <form data-action="/emergency-stop" data-method="POST">
        <button type="submit">EMERGENCY STOP</button>
    </form>

    <hr>

    <h2>G-code & Files</h2>

    <h3>List SD Card Files</h3>
    <form data-action="/sd/files" data-method="GET">
        <button type="submit">List Files</button>
    </form>

    <h3>Get SD Card Info</h3>
    <form data-action="/sd/info" data-method="GET">
        <button type="submit">Get SD Info</button>
    </form>

    <h3>Upload File to SD Card</h3>
    <form data-action="/sd/upload" data-method="POST">
        <label>Filename: <input type="text" name="filename" required placeholder="myfile.g"></label><br>
        <label>G-code Content:</label><br>
        <textarea name="content" rows="10" cols="50" required placeholder="G28&#10;G0 X100 Y100&#10;M0"></textarea><br>
        <button type="submit">Upload File</button>
    </form>

    <h3>Execute G-code File</h3>
    <form data-action="/execute" data-method="POST">
        <label>Filename: <input type="text" name="filename" required></label><br>
        <button type="submit">Execute File</button>
    </form>

    <h3>Send Raw G-code</h3>
    <form data-action="/gcode" data-method="POST">
        <label>G-code Command: <input type="text" name="command" required placeholder="e.g., G28 X Y"></label><br>
        <button type="submit">Send G-code</button>
    </form>

    <hr>

    <h2>GPIO Control</h2>

    <h3>Set GPIO Pin</h3>
    <form data-action="/gpio/send" data-method="POST">
        <label>Pin: <input type="number" name="pin" required></label><br>
        <label>Value: <input type="number" name="value" required></label><br>
        <button type="submit">Set GPIO</button>
    </form>

    <h3>Read GPIO Pin</h3>
    <form data-action="/gpio/read" data-method="GET">
        <label>Pin: <input type="number" name="pin" required></label><br>
        <button type="submit">Read GPIO</button>
    </form>

    <hr>

    <h2>System Management</h2>

    <h3>Get System Uptime</h3>
    <form data-action="/system/uptime" data-method="GET">
        <button type="submit">Get Uptime</button>
    </form>

    <h3>Schedule System Shutdown</h3>
    <form data-action="/system/shutdown" data-method="POST">
        <label>Minutes (default 5): <input type="number" name="minutes" min="0"></label><br>
        <button type="submit">Schedule Shutdown</button>
    </form>

    <h3>Cancel Scheduled Shutdown</h3>
    <form data-action="/system/shutdown/cancel" data-method="POST">
        <button type="submit">Cancel Shutdown</button>
    </form>

    <h3>Restart System</h3>
    <form data-action="/system/restart" data-method="POST">
        <button type="submit">Restart Raspberry Pi</button>
    </form>

    <hr>

    <footer>
        <p><small>Gellyroller API Kitchen Sink - Test all endpoints</small></p>
    </footer>

    <script>
        // Get textareas
        const responseArea = document.getElementById('response');
        const dataOutputArea = document.getElementById('dataOutput');

        // Function to extract and display data
        function displayData(responseData) {
            // Check if response has a data property
            if (responseData && responseData.data && responseData.data.data !== undefined) {
                let dataValue = responseData.data.data;
                
                // If data is an object or array, stringify it
                if (typeof dataValue === 'object') {
                    dataValue = JSON.stringify(dataValue, null, 2);
                }
                
                // Convert to string if not already
                dataValue = String(dataValue);
                
                // Convert \n to actual newlines for display
                dataValue = dataValue.replace(/\\n/g, '\n');
                
                // Display in data output area
                dataOutputArea.value = dataValue;
            } else {
                dataOutputArea.value = 'No data field in response';
            }
        }

        // Function to display full response
        function displayResponse(data) {
            responseArea.value = JSON.stringify(data, null, 2);
            displayData(data);
        }

        // Function to display error
        function displayError(error) {
            responseArea.value = 'Error: ' + error.message;
            dataOutputArea.value = 'Error occurred';
        }

        // Function to get form data as object
        function getFormData(form) {
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                if (value !== '') {
                    // Convert to number if it's a number input
                    const input = form.elements[key];
                    if (input && input.type === 'number' && value !== '') {
                        data[key] = parseFloat(value);
                    } else {
                        data[key] = value;
                    }
                }
            }
            
            return data;
        }

        // Function to make API request
        async function makeRequest(url, method, data) {
            responseArea.value = 'Loading...';
            dataOutputArea.value = 'Loading...';
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                // Add body for POST/PUT requests
                if (method === 'POST' || method === 'PUT') {
                    options.body = JSON.stringify(data);
                }

                // Add query params for GET requests
                if (method === 'GET' && Object.keys(data).length > 0) {
                    const params = new URLSearchParams(data);
                    url += '?' + params.toString();
                }

                const response = await fetch(url, options);
                const result = await response.json();
                
                displayResponse({
                    status: response.status,
                    statusText: response.statusText,
                    data: result
                });
            } catch (error) {
                displayError(error);
            }
        }

        // Add event listeners to all forms
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const action = form.getAttribute('data-action');
                const method = form.getAttribute('data-method');
                const data = getFormData(form);
                
                await makeRequest(action, method, data);
            });
        });

        // Initial messages
        responseArea.value = 'Ready. Submit a form to see the response.';
        dataOutputArea.value = 'Ready. Data output will appear here.';
    </script>
</body>
</html>